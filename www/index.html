<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢˜åº“ - TF Algo</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="navbar">
        <h1>ğŸ“š ç®—æ³•é¢˜è§£åº“</h1>
        <div class="nav-links">
            <a href="/add.html">â• æ·»åŠ é¢˜è§£</a>
            <a href="/qa.html">ğŸ’¬ æé—®ç®±</a>
        </div>
    </div>

    <div class="search-bar">
        <!-- æ”¯æŒæŒ‰ ID æˆ– æ ‡é¢˜æœç´¢ -->
        <input type="text" id="searchBox" placeholder="è¾“å…¥é¢˜ç›®ç¼–å· æˆ– æ ‡é¢˜å…³é”®è¯..." onkeypress="handleEnter(event)">
        <button onclick="resetAndLoad()">æœç´¢</button>
    </div>
    
    <div class="problem-list-container">
        <!-- è¡¨å¤´ -->
        <div class="list-header">
            <div class="col-id">#</div>
            <div class="col-title">é¢˜ç›®åç§°</div>
            <div class="col-algo">ç®—æ³•æ ‡ç­¾</div>
            <div class="col-diff">éš¾åº¦</div>
            <div class="col-action">æ“ä½œ</div>
        </div>
        
        <!-- åˆ—è¡¨å†…å®¹åŒºåŸŸ -->
        <div id="problemList"></div>
        
        <!-- åº•éƒ¨åŠ è½½æç¤ºå“¨å…µ -->
        <div id="loading-sentinel">æ­£åœ¨åŠ è½½æ›´å¤š...</div>
    </div>

    <script>
        const difficultyMap = { 'Easy': 'ç®€å•', 'Medium': 'ä¸­ç­‰', 'Hard': 'å›°éš¾' };
        
        // åˆ†é¡µçŠ¶æ€
        let currentOffset = 0;
        const limit = 15;
        let isLoading = false;
        let hasMore = true;
        let currentKeyword = "";

        function handleEnter(e) { if (e.key === 'Enter') resetAndLoad(); }

        // é‡ç½®æœç´¢ï¼ˆç‚¹å‡»æœç´¢æŒ‰é’®æˆ–åˆ·æ–°æ—¶ï¼‰
        function resetAndLoad() {
            currentKeyword = document.getElementById('searchBox').value.trim();
            currentOffset = 0;
            hasMore = true;
            document.getElementById('problemList').innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            loadMore();
        }

        // åˆ é™¤é€»è¾‘
        async function deleteProblem(id, event) {
            event.stopPropagation();
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜å—ï¼Ÿ")) return;
            try {
                const response = await fetch('/api/problems/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `id=${id}`
                });
                if (response.ok) {
                    // åˆ é™¤ DOM å…ƒç´ è€Œä¸æ˜¯é‡æ–°åŠ è½½ï¼Œä½“éªŒæ›´å¥½
                    const row = document.getElementById(`row-${id}`);
                    if(row) row.remove();
                } else {
                    alert("åˆ é™¤å¤±è´¥");
                }
            } catch (err) { alert("è¯·æ±‚å‡ºé”™"); }
        }

        // åŠ è½½æ•°æ®æ ¸å¿ƒé€»è¾‘
        async function loadMore() {
            if (isLoading || !hasMore) return;
            
            isLoading = true;
            const sentinel = document.getElementById('loading-sentinel');
            sentinel.innerText = "æ­£åœ¨åŠ è½½æ›´å¤š...";
            sentinel.style.display = 'block';

            try {
                const url = `/api/problems?search=${encodeURIComponent(currentKeyword)}&offset=${currentOffset}&limit=${limit}`;
                const response = await fetch(url);
                const resData = await response.json();
                
                const problems = resData.data;
                const total = resData.total;

                if (problems.length === 0) {
                    hasMore = false;
                    sentinel.innerText = currentOffset === 0 ? "æš‚æ— æ•°æ®" : "â€”â€” åˆ°åº•äº† â€”â€”";
                    isLoading = false;
                    return;
                }

                const listDiv = document.getElementById('problemList');
                
                problems.forEach(p => {
                    const diffClass = `diff-${p.difficulty}`;
                    const diffText = difficultyMap[p.difficulty] || p.difficulty;
                    const algoText = p.algorithm || (p.tags ? p.tags.join(', ') : '-');

                    const row = document.createElement('div');
                    row.className = 'list-row';
                    row.id = `row-${p.id}`;
                    row.innerHTML = `
                        <div class="col-id">${p.id}</div>
                        <div class="col-title"><a href="/problem.html?id=${p.id}">${p.title}</a></div>
                        <div class="col-algo">${algoText}</div>
                        <div class="col-diff ${diffClass}">${diffText}</div>
                        <div class="col-action">
                            <button onclick="deleteProblem(${p.id}, event)" style="border:none; background:none; cursor:pointer; color:#ccc;">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    listDiv.appendChild(row);
                });

                currentOffset += problems.length;
                if (currentOffset >= total) {
                    hasMore = false;
                    sentinel.innerText = "â€”â€” åˆ°åº•äº† â€”â€”";
                }

            } catch (err) {
                console.error(err);
                sentinel.innerText = "åŠ è½½å¤±è´¥";
            } finally {
                isLoading = false;
            }
        }

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶å®ç°æ— é™åŠ è½½
        window.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            // å½“æ»šåŠ¨æ¡è·ç¦»åº•éƒ¨å°äº 100px æ—¶ï¼Œè§¦å‘åŠ è½½
            if (scrollTop + clientHeight >= scrollHeight - 100) {
                loadMore();
            }
        });

        // åˆå§‹åŠ è½½
        resetAndLoad();
    </script>
</body>
</html>