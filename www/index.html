<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢˜åº“ - TF Algo</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="navbar">
        <h1> TFéŸ©æœ¯-ç®—æ³•é¢˜è§£åº“</h1>
        <div class="nav-links">
            <a href="/add.html">â• æ·»åŠ é¢˜è§£</a>
            <a href="/qa.html">ğŸ’¬ æé—®ç®±</a>
        </div>
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h3>ğŸ“ æ”¶è—å¤¹</h3>
            <ul id="favListSidebar">
                <li class="active" onclick="selectFav(-1, this)">å…¨éƒ¨é¢˜ç›®</li>
                <!-- åŠ¨æ€åŠ è½½æ”¶è—å¤¹ -->
            </ul>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="content-area">
            <div class="search-bar">
                <input type="text" id="searchBox" placeholder="è¾“å…¥é¢˜ç›®ç¼–å· æˆ– æ ‡é¢˜å…³é”®è¯..." onkeypress="handleEnter(event)">
                <button onclick="resetAndLoad()">æœç´¢</button>
            </div>

            <div id="tagContainer" class="tag-filter-area"></div>

            <div class="problem-list-container">
                <!-- è¡¨å¤´ -->
                <div class="list-header">
                    <div class="col-id">#</div>
                    <div class="col-title">é¢˜ç›®åç§°</div>
                    <div class="col-algo">ç®—æ³•æ ‡ç­¾</div>
                    <div class="col-diff">éš¾åº¦</div>
                    <div class="col-action">æ“ä½œ</div>
                </div>
                
                <!-- åˆ—è¡¨å†…å®¹åŒºåŸŸ -->
                <div id="problemList"></div>
                
                <!-- åº•éƒ¨åŠ è½½æç¤ºå“¨å…µ -->
                <div id="loading-sentinel">æ­£åœ¨åŠ è½½æ›´å¤š...</div>
            </div>
        </div>
    </div>

    <div id="tagContainer" class="tag-filter-area">
        <!-- åŠ¨æ€åŠ è½½æ ‡ç­¾ -->
    </div>

    <!-- ç»Ÿä¸€çš„æ”¶è—ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="manageFavModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç®¡ç†æ”¶è—</h3>
                <span class="close" onclick="closeManageModal()">&times;</span>
            </div>
            <div id="manageFavListContainer" class="fav-list-container">
                <!-- åŠ¨æ€åŠ è½½æ”¶è—å¤¹åˆ—è¡¨ -->
            </div>
            <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                <input type="text" id="newFavName" placeholder="æ–°å»ºæ”¶è—å¤¹" style="width: 65%;">
                <button onclick="createFavorite()">æ–°å»º</button>
            </div>
        </div>
    </div>
    
    <script>
        const difficultyMap = { 'Easy': 'ç®€å•', 'Medium': 'ä¸­ç­‰', 'Hard': 'å›°éš¾' };
        let currentFavId = -1; // -1 è¡¨ç¤ºå…¨éƒ¨
        // åˆ†é¡µçŠ¶æ€
        let currentOffset = 0;
        const limit = 15;
        let isLoading = false;
        let hasMore = true;
        let currentKeyword = "";
        let currentTag = ""; // å½“å‰é€‰ä¸­çš„æ ‡ç­¾
        let currentProblemIdToFav = 0; // å½“å‰è¦æ”¶è—çš„é¢˜ç›®ID

        function handleEnter(e) { if (e.key === 'Enter') resetAndLoad(); }

        // é‡ç½®æœç´¢ï¼ˆç‚¹å‡»æœç´¢æŒ‰é’®æˆ–åˆ·æ–°æ—¶ï¼‰
        function resetAndLoad() {
            currentKeyword = document.getElementById('searchBox').value.trim();
            currentOffset = 0;
            hasMore = true;
            document.getElementById('problemList').innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            loadMore();
        }

        // ---------------- åˆå§‹åŒ–åŠ è½½ ----------------
        async function init() {
            await loadTags();
            await loadSidebar();
            resetAndLoad();
        }

        // åˆå§‹åŒ–ä¾§è¾¹æ 
        async function loadSidebar() {
            // è®°å½•å½“å‰é€‰ä¸­çš„ IDï¼Œä»¥ä¾¿é‡ç»˜åæ¢å¤é«˜äº®
            // æ³¨æ„ï¼šcurrentFavId æ˜¯å…¨å±€å˜é‡ï¼Œè¿™æ­¥å…¶å®æ˜¯å¤šä½™çš„ï¼Œä½†é€»è¾‘ä¸Šæ›´æ¸…æ™°
            const activeId = currentFavId; 
            const res = await fetch('/api/favorites');
            const favs = await res.json();
            const ul = document.getElementById('favListSidebar');
            
            // ä¿ç•™"å…¨éƒ¨é¢˜ç›®"
            ul.innerHTML = ''; // æ¸…ç©º
            
            // å…¨éƒ¨é¢˜ç›®é¡¹
            const allLi = document.createElement('li');
            if (activeId === -1) allLi.className = 'active';
            allLi.innerText = 'å…¨éƒ¨é¢˜ç›®';
            allLi.onclick = () => selectFav(-1, allLi);
            ul.appendChild(allLi);
            
            // æ”¶è—å¤¹é¡¹
            favs.forEach(f => {
                const li = document.createElement('li');
                if (f.id === activeId) li.className = 'active';
                li.onclick = () => selectFav(f.id, li);
                li.innerHTML = `<span>${f.name}</span> <span class="count">${f.problem_ids.length}</span>`;
                ul.appendChild(li);
            });
        }

        // ---------------- æ ‡ç­¾åŠŸèƒ½ ----------------
        async function loadTags() {
            const res = await fetch('/api/tags');
            const tags = await res.json();
            const container = document.getElementById('tagContainer');
            
            // "å…¨éƒ¨" æ ‡ç­¾
            container.innerHTML = `<span class="filter-tag active" onclick="selectTag('', this)">å…¨éƒ¨</span>`;
            
            tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = 'filter-tag';
                span.innerText = tag;
                span.onclick = function() { selectTag(tag, this); };
                container.appendChild(span);
            });
        }

        function selectTag(tag, element) {
            currentTag = tag;
            // åˆ‡æ¢ UI æ ·å¼
            document.querySelectorAll('.filter-tag').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            // é‡æ–°åŠ è½½åˆ—è¡¨
            resetAndLoad();
        }


        // åˆ é™¤é€»è¾‘
        async function deleteProblem(id, event) {
            event.stopPropagation();
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜å—ï¼Ÿ")) return;
            try {
                const response = await fetch('/api/problems/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `id=${id}`
                });
                if (response.ok) {
                    // åˆ é™¤ DOM å…ƒç´ è€Œä¸æ˜¯é‡æ–°åŠ è½½ï¼Œä½“éªŒæ›´å¥½
                    const row = document.getElementById(`row-${id}`);
                    if(row) row.remove();
                    else console.warn(`Cannot find element row-${id} to remove`); // è°ƒè¯•æ—¥å¿—
                } else {
                    alert("åˆ é™¤å¤±è´¥");
                }
            } catch (err) { alert("è¯·æ±‚å‡ºé”™"); }
        }

        // åŠ è½½æ•°æ®æ ¸å¿ƒé€»è¾‘
        async function loadMore() {
            if (isLoading || !hasMore) return;
            isLoading = true;
            const sentinel = document.getElementById('loading-sentinel');
            sentinel.innerText = "æ­£åœ¨åŠ è½½æ›´å¤š...";
            sentinel.style.display = 'block';

            try {
                const url = `/api/problems?search=${encodeURIComponent(currentKeyword)}&tag=${encodeURIComponent(currentTag)}&fav_id=${currentFavId}&offset=${currentOffset}&limit=${limit}`;
                const response = await fetch(url);
                const resData = await response.json();
                
                const problems = resData.data;
                const total = resData.total;

                if (problems.length === 0) {
                    hasMore = false;
                    sentinel.innerText = currentOffset === 0 ? "æš‚æ— æ•°æ®" : "â€”â€” åˆ°åº•äº† â€”â€”";
                    isLoading = false;
                    return;
                }

                const listDiv = document.getElementById('problemList');
                
                problems.forEach(p => {
                    const diffClass = `diff-${p.difficulty}`;
                    const diffText = difficultyMap[p.difficulty] || p.difficulty;
                    const algoText = p.algorithm || (p.tags ? p.tags.join(', ') : '-');
                    const favClass = p.is_favorited ? 'btn-fav active' : 'btn-fav';

                    const row = document.createElement('div');
                    row.className = 'list-row';
                    row.id = `row-${p.id}`;
                    
                    // **æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨ col-action ä¸­æ·»åŠ æ”¶è—æŒ‰é’®**
                    row.innerHTML = `
                        <div class="col-id">${p.id}</div>
                        <div class="col-title"><a href="/problem.html?id=${p.id}">${p.title}</a></div>
                        <div class="col-algo">${algoText}</div>
                        <div class="col-diff ${diffClass}">${diffText}</div>
                        <div class="col-action">
                        <button class="${favClass}" onclick="handleFavClick(${p.id}, ${p.is_favorited}, event)" title="æ”¶è—">â˜…</button>
                        <button onclick="deleteProblem(${p.id}, event)" style="..." title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                `;
                    listDiv.appendChild(row);
                });

                currentOffset += problems.length;
                if (currentOffset >= total) {
                    hasMore = false;
                    sentinel.innerText = "â€”â€” åˆ°åº•äº† â€”â€”";
                }

            } catch (err) {
                console.error(err);
                sentinel.innerText = "åŠ è½½å¤±è´¥";
            } finally {
                isLoading = false;
            }
        }

        // ç‚¹å‡»æ˜Ÿæ˜Ÿçš„é€»è¾‘å…¥å£
        async function handleFavClick(id, isFav, event) {
            event.stopPropagation();
            currentProblemIdToFav = id;
            openManageFavModal(id);
        }

        // æ‰“å¼€ç»Ÿä¸€ç®¡ç†æ¨¡æ€æ¡†
        async function openManageFavModal(problemId) {
            const modal = document.getElementById('manageFavModal');
            const container = document.getElementById('manageFavListContainer');
            container.innerHTML = '<div style="text-align:center; color:#999;">åŠ è½½ä¸­...</div>';
            modal.style.display = "block";

            try {
                // è·å–æ‰€æœ‰æ”¶è—å¤¹
                const res = await fetch('/api/favorites');
                const favs = await res.json();
                
                container.innerHTML = '';
                
                if (favs.length === 0) {
                    container.innerHTML = '<div style="padding:10px; text-align:center;">æš‚æ— æ”¶è—å¤¹ï¼Œè¯·å…ˆæ–°å»º</div>';
                }

                favs.forEach(f => {
                    // åˆ¤æ–­å½“å‰é¢˜ç›®æ˜¯å¦åœ¨è¿™ä¸ªæ”¶è—å¤¹é‡Œ
                    const isInFav = f.problem_ids.includes(problemId);
                    
                    const div = document.createElement('div');
                    div.className = 'fav-item';
                    // ä½¿ç”¨ onclick è§¦å‘ toggleFav
                    // æ³¨æ„ï¼šé˜»æ­¢ checkbox çš„ç‚¹å‡»å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘ div çš„ç‚¹å‡»
                    div.innerHTML = `
                        <input type="checkbox" id="fav-${f.id}" ${isInFav ? 'checked' : ''} 
                            onchange="toggleFav(${f.id}, this.checked)">
                        <label for="fav-${f.id}">${f.name} <span style="color:#999; font-size:0.8em;">(${f.problem_ids.length})</span></label>
                    `;
                    container.appendChild(div);
                });

            } catch (err) {
                console.error(err);
                container.innerText = "åŠ è½½å¤±è´¥";
            }
        }

        // æ‰“å¼€â€œå–æ¶ˆæ”¶è—â€æ¨¡æ€æ¡†
        async function openRemoveFavModal(problemId) {
            const modal = document.getElementById('removeFavModal');
            const container = document.getElementById('removeFavListContainer');
            container.innerHTML = '<div style="text-align:center; color:#999;">åŠ è½½ä¸­...</div>';
            modal.style.display = "block";

            try {
                // è·å–æ‰€æœ‰æ”¶è—å¤¹æ•°æ®
                const res = await fetch('/api/favorites');
                const favs = await res.json();
                
                container.innerHTML = '';
                let count = 0;

                if (favs.length === 0) {
                    container.innerHTML = '<div style="padding:10px; text-align:center;">æš‚æ— æ”¶è—å¤¹ï¼Œè¯·å…ˆæ–°å»º</div>';
                }

                // ç­›é€‰å‡ºåŒ…å«å½“å‰é¢˜ç›®çš„æ”¶è—å¤¹
                favs.forEach(f => {
                    const isInFav = f.problem_ids.includes(problemId);
                    if (f.problem_ids.includes(problemId)) {
                        count++;
                        const div = document.createElement('div');
                        div.className = 'fav-item';
                        div.style.cursor = 'default'; // è¿™é‡Œä¸éœ€è¦ç‚¹å‡»æ•´è¡Œ
                        div.innerHTML = `
                            <input type="checkbox" id="fav-${f.id}" ${isInFav ? 'checked' : ''} 
                                onchange="toggleFav(${f.id}, this.checked)">
                            <label for="fav-${f.id}">${f.name} <span style="color:#999; font-size:0.8em;">(${f.problem_ids.length})</span></label>
                        `;
                        container.appendChild(div);
                    }
                });

                if (count === 0) {
                    // ç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼ˆisFav=trueä½†æ²¡æ‰¾åˆ°ï¼‰ï¼Œä¸ºäº†å®¹é”™
                    container.innerHTML = '<p style="color:red">æ•°æ®ä¸åŒæ­¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p>';
                }

            } catch (err) {
                console.error(err);
                container.innerText = "åŠ è½½å¤±è´¥";
            }
        }

        function closeManageModal() {
            document.getElementById('manageFavModal').style.display = "none";
            // å…³é—­æ—¶åˆ·æ–°ä¸€ä¸‹åˆ—è¡¨ï¼Œæ›´æ–°æ˜Ÿæ˜ŸçŠ¶æ€ï¼ˆé‡‘/ç°ï¼‰
            // ç®€å•ç­–ç•¥ï¼šé‡æ–°åŠ è½½å½“å‰è§†å›¾
            // æˆ–è€…æ›´ç²¾ç»†åœ°ï¼šå¦‚æœè¯¥é¢˜ç›®ç°åœ¨å±äºè‡³å°‘ä¸€ä¸ªæ”¶è—å¤¹ï¼Œè®¾ä¸º activeï¼Œå¦åˆ™ remove active
            // è¿™é‡Œä¸ºäº†æ•°æ®ä¸€è‡´æ€§ï¼Œå»ºè®®åˆ·æ–°
            resetAndLoad(); 
        }

        // åˆ‡æ¢æ”¶è—çŠ¶æ€ (æ ¸å¿ƒé€»è¾‘)
        async function toggleFav(favId, isChecked) {
            const url = isChecked ? '/api/favorites/add' : '/api/favorites/remove';
            // å¦‚æœæ˜¯ removeï¼Œæˆ‘ä»¬ä¹‹å‰çš„ API å‚æ•°æ˜¯ problem_id + fav_id
            // å¦‚æœæ˜¯ addï¼Œå‚æ•°æ˜¯ problem_id + fav_id
            // å‚æ•°åå®Œå…¨ä¸€è‡´ï¼Œå®Œç¾ï¼
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `fav_id=${favId}&problem_id=${currentProblemIdToFav}`
                });
                
                if (!res.ok) {
                    alert("æ“ä½œå¤±è´¥");
                    // å›æ»š checkbox çŠ¶æ€
                    const checkbox = document.getElementById(`fav-${favId}`);
                    checkbox.checked = !isChecked;
                } else {
                    // æ“ä½œæˆåŠŸï¼Œä¸éœ€è¦å¼¹çª—å¹²æ‰°ç”¨æˆ·
                    // TODOå¯ä»¥åšä¸€ä¸ªå°çš„ toast æç¤ºï¼Œè¿™é‡Œçœç•¥
                    // é¢‘ç¹åˆ·æ–°å¯èƒ½ä¼šæœ‰è½»å¾®çš„æ€§èƒ½æŸè€—æˆ–è§†è§‰è·³åŠ¨ï¼Œä½†å¯¹äºå½“å‰è§„æ¨¡å®Œå…¨å¯æ¥å—
                    loadSidebar(); 
                }
            } catch (err) {
                alert("ç½‘ç»œé”™è¯¯");
            }
        }

        // æ‰§è¡Œç§»é™¤æ“ä½œ
        // favId: æŒ‡å®šæ”¶è—å¤¹IDï¼Œæˆ–è€… -1 è¡¨ç¤ºå…¨éƒ¨
        async function removeFromFav(favId) {
            if (favId === -1 && !confirm("ç¡®å®šè¦ä»æ‰€æœ‰æ”¶è—å¤¹ä¸­ç§»é™¤å—ï¼Ÿ")) return;

            try {
                const res = await fetch('/api/favorites/remove', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    // å…³é”®ï¼šä¼ é€’ fav_id å‚æ•°
                    body: `problem_id=${currentProblemIdToFav}&fav_id=${favId}`
                });

                if (res.ok) {
                    // é€»è¾‘åˆ¤æ–­ï¼š
                    // å¦‚æœæ˜¯ç§»é™¤å…¨éƒ¨ (-1)ï¼Œç›´æ¥å…³é—­æ¨¡æ€æ¡†å¹¶æ›´æ–°UI
                    // å¦‚æœæ˜¯ç§»é™¤å•ä¸ªï¼Œåˆ·æ–°æ¨¡æ€æ¡†åˆ—è¡¨ã€‚å¦‚æœåˆ—è¡¨ç©ºäº†ï¼Œå…³é—­æ¨¡æ€æ¡†å¹¶æ›´æ–°UIã€‚
                    
                    if (favId === -1) {
                        updateUiAfterRemove();
                        closeRemoveModal();
                    } else {
                        // é‡æ–°åŠ è½½æ¨¡æ€æ¡†å†…å®¹ï¼Œæ£€æŸ¥æ˜¯å¦è¿˜å‰©å…¶ä»–æ”¶è—å¤¹
                        // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œå…ˆå…³é—­ï¼Œå¦‚æœç”¨æˆ·æƒ³ç»§ç»­åˆ å†ç‚¹å¼€ï¼ˆæˆ–è€…ä½ å¯ä»¥ä¼˜åŒ–ä¸ºå±€éƒ¨åˆ·æ–°ï¼‰
                        // ä¸ºäº†ç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦è¿˜éœ€è¦ä¿ç•™é‡‘æ˜Ÿ
                        // ä½†å‰ç«¯ä¸çŸ¥é“æ˜¯å¦è¿˜æœ‰å…¶ä»–æ”¶è—å¤¹ï¼Œé™¤éé‡æ–°è¯·æ±‚
                        // ç®€å•ç­–ç•¥ï¼šæ“ä½œä¸€æ¬¡åå…³é—­æ¨¡æ€æ¡†ï¼Œåˆ·æ–°åˆ—è¡¨
                        updateUiAfterRemove(); // è¿™é‡Œæ¯”è¾ƒæš´åŠ›ï¼Œç›´æ¥åˆ·æ–°åˆ—è¡¨
                        closeRemoveModal();
                    }
                } else {
                    alert("ç§»é™¤å¤±è´¥");
                }
            } catch (err) {
                alert("è¯·æ±‚é”™è¯¯");
            }
        }

        // ç§»é™¤æˆåŠŸåçš„ UI æ›´æ–°
        function updateUiAfterRemove() {
            loadSidebar(); // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
            
            // é‡æ–°åŠ è½½åˆ—è¡¨æ˜¯æœ€ç¨³å¦¥çš„ï¼Œèƒ½æ­£ç¡®è®¡ç®— is_favorited çŠ¶æ€
            // å¦‚æœä¸æƒ³é‡æ–°åŠ è½½ï¼Œéœ€è¦å¤æ‚çš„é€»è¾‘å»åˆ¤æ–­è¯¥é¢˜ç›®æ˜¯å¦è¿˜å­˜åœ¨äºå…¶ä»–æ”¶è—å¤¹ä¸­
            // é‰´äºè¿™æ˜¯åå°ç®¡ç†æ€§è´¨çš„æ“ä½œï¼Œé‡æ–°åŠ è½½æ˜¯å¯ä»¥æ¥å—çš„
            
            // å¦‚æœå½“å‰æ˜¯åœ¨ç‰¹å®šçš„æ”¶è—å¤¹è§†å›¾ä¸‹ç§»é™¤äº†é¢˜ç›®ï¼Œé‚£ä¹ˆè¯¥é¢˜ç›®åº”è¯¥ä»åˆ—è¡¨ä¸­æ¶ˆå¤±
            if (currentFavId !== -1) {
                // å¦‚æœåªæ˜¯ä»å½“å‰è§†å›¾çš„æ”¶è—å¤¹ç§»é™¤äº†ï¼Œé‡æ–°åŠ è½½ä¼šè‡ªåŠ¨å»æ‰å®ƒ
                resetAndLoad(); 
            } else {
                // å¦‚æœæ˜¯åœ¨"å…¨éƒ¨é¢˜ç›®"è§†å›¾ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å®ƒæ˜¯å¦å®Œå…¨è¢«ç§»é™¤äº†æ‰èƒ½å†³å®šæ˜¯å¦å˜ç°æ˜Ÿ
                // ä¸ºäº†æ•°æ®ä¸€è‡´æ€§ï¼Œé‡æ–°åŠ è½½
                resetAndLoad();
            }
        }

        // ---------------- æ”¶è—å¤¹åŠŸèƒ½ ----------------
    
        // æ‰“å¼€æ¨¡æ€æ¡†
        async function openFavModal(problemId, event) {
            event.stopPropagation(); // é˜²æ­¢è§¦å‘è¡Œç‚¹å‡»è·³è½¬
            currentProblemIdToFav = problemId;
            const modal = document.getElementById('favModal');
            modal.style.display = "block";
            
            // åŠ è½½æ”¶è—å¤¹åˆ—è¡¨
            const res = await fetch('/api/favorites');
            const favs = await res.json();
            const container = document.getElementById('favListContainer');
            container.innerHTML = '';
            
            favs.forEach(f => {
                const div = document.createElement('div');
                div.className = 'fav-item';
                div.innerText = f.name + ` (${f.problem_ids.length})`;
                div.onclick = () => addToFav(f.id);
                container.appendChild(div);
            });
        }
        
        function closeModal() {
            document.getElementById('favModal').style.display = "none";
        }
        
        // æ‰§è¡Œæ·»åŠ 
        async function addToFav(favId) {
            const res = await fetch('/api/favorites/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `fav_id=${favId}&problem_id=${currentProblemIdToFav}`
            });
            if (res.ok) {
                alert("å·²æ·»åŠ !");
                closeModal();
                loadSidebar(); // åˆ·æ–°ä¾§è¾¹æ è®¡æ•°
                // åˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°æ˜Ÿæ˜ŸçŠ¶æ€ (æˆ–è€…æ‰‹åŠ¨æ›´æ–° DOM)
                // ç®€å•èµ·è§ï¼Œå¦‚æœä¸é‡ç½®åˆ—è¡¨ï¼Œè‡³å°‘è¦æŠŠå½“å‰æ˜Ÿæ˜Ÿå˜é»„
                const row = document.getElementById(`row-${currentProblemIdToFav}`);
                if(row) {
                    const btn = row.querySelector('.btn-fav');
                    btn.classList.add('active');
                    // æ›´æ–°ç‚¹å‡»äº‹ä»¶ä¸ºå–æ¶ˆæ”¶è—
                    // æ³¨æ„ï¼šè¿™é‡Œç”¨é—­åŒ…å¯èƒ½ä¼šæœ‰å‘ï¼Œæœ€ç¨³å¦¥æ˜¯é‡æ–°åŠ è½½åˆ—è¡¨
                    // ä½†ä¸ºäº†ä½“éªŒï¼Œæˆ‘ä»¬å¯ä»¥åªæ”¹æ ·å¼ï¼Œä¸‹æ¬¡åŠ è½½è‡ªç„¶æ­£ç¡®
                    btn.onclick = (e) => handleFavClick(currentProblemIdToFav, true, e);
                }
            }else {
                alert("æ·»åŠ å¤±è´¥");
            }
        }

        // æ–°å»ºæ”¶è—å¤¹
        async function createFavorite() {
            const name = document.getElementById('newFavName').value;
            if (!name) return;
            
            const res = await fetch('/api/favorites/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `name=${encodeURIComponent(name)}`
            });
            
            if (res.ok) {
                document.getElementById('newFavName').value = '';
                // **åˆ·æ–°ä¾§è¾¹æ ï¼Œæ˜¾ç¤ºæ–°åˆ›å»ºçš„æ”¶è—å¤¹**
                loadSidebar(); 
                // åˆ·æ–°åˆ—è¡¨ï¼Œæ–°åˆ›å»ºçš„æ”¶è—å¤¹ä¼šå‡ºç°åœ¨åˆ—è¡¨é‡Œï¼Œä¸”æœªå‹¾é€‰
                openManageFavModal(currentProblemIdToFav); 
            }
        }

        // é€‰æ‹©æ”¶è—å¤¹
        function selectFav(id, el) {
            currentFavId = id;
            // UI æ›´æ–°
            document.querySelectorAll('.sidebar li').forEach(l => l.classList.remove('active'));
            el.classList.add('active');
            // é‡ç½®åˆ—è¡¨
            resetAndLoad();
        }

        // å…³é—­ç§»é™¤æ¨¡æ€æ¡†
        function closeRemoveModal() {
            document.getElementById('removeFavModal').style.display = "none";
        }

        // ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        window.onclick = function(event) {
            const modal = document.getElementById('manageFavModal');
            if (event.target == modal) {
                closeManageModal();
            }
        }

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶å®ç°æ— é™åŠ è½½
        window.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            // å½“æ»šåŠ¨æ¡è·ç¦»åº•éƒ¨å°äº 100px æ—¶ï¼Œè§¦å‘åŠ è½½
            if (scrollTop + clientHeight >= scrollHeight - 100) {
                loadMore();
            }
        });

        // åˆå§‹åŠ è½½
        resetAndLoad();
        init();
    </script>
    
</body>
</html>