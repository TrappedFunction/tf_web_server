<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—æ³•é¢˜è§£åº“ - TF Server</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="navbar">
        <h1>ğŸ“š ç®—æ³•é¢˜è§£åº“</h1>
        <div class="nav-links">
            <a href="/add.html">â• æ·»åŠ é¢˜è§£</a>
            <a href="/qa.html">ğŸ’¬ æé—®ç®±</a>
        </div>
    </div>

    <!-- æœç´¢åŒºåŸŸ -->
    <div class="search-bar">
        <input type="text" id="searchBox" placeholder="æœç´¢é¢˜ç›®åç§°æˆ–å…³é”®è¯..." onkeypress="handleEnter(event)">
        <button onclick="loadProblems()">æœç´¢</button>
    </div>
    
    <!-- é¢˜ç›®åˆ—è¡¨ -->
    <div id="loading" style="text-align:center; color:#999; display:none;">åŠ è½½ä¸­...</div>
    <div id="problemList">
        <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹å°†åœ¨è¿™é‡Œ -->
    </div>

    <script>
        // å¤„ç†å›è½¦é”®æœç´¢
        function handleEnter(e) {
            if (e.key === 'Enter') loadProblems();
        }

        // éš¾åº¦ä¸­æ–‡æ˜ å°„
        const difficultyMap = {
            'Easy': 'ç®€å•',
            'Medium': 'ä¸­ç­‰',
            'Hard': 'å›°éš¾'
        };

        // åˆ é™¤å‡½æ•°
        async function deleteProblem(id, event) {
            event.preventDefault(); // é˜²æ­¢é“¾æ¥è·³è½¬
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜å—ï¼Ÿ")) return;

            try {
                // å‘é€ POST è¯·æ±‚æ¥åˆ é™¤ï¼ŒBody ä¸­åŒ…å« ID
                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬éœ€è¦æ„é€  x-www-form-urlencoded æ ¼å¼çš„æ•°æ®
                // å› ä¸ºæˆ‘ä»¬çš„åç«¯ parsePost åªæ”¯æŒè¿™ç§æ ¼å¼
                const response = await fetch('/api/problems/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${id}`
                });

                if (response.ok) {
                    alert("åˆ é™¤æˆåŠŸ");
                    loadProblems(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    alert("åˆ é™¤å¤±è´¥");
                }
            } catch (err) {
                console.error(err);
                alert("è¯·æ±‚å‡ºé”™");
            }
        }

        async function loadProblems() {
            const keyword = document.getElementById('searchBox').value;
            const listDiv = document.getElementById('problemList');
            const loadingDiv = document.getElementById('loading');

            listDiv.innerHTML = '';
            loadingDiv.style.display = 'block';

            try {
                const response = await fetch(`/api/problems?search=${encodeURIComponent(keyword)}`);
                const problems = await response.json();
                
                loadingDiv.style.display = 'none';

                if (problems.length === 0) {
                    listDiv.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#666; padding:40px;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é¢˜ç›®</div>';
                    return;
                }

                problems.forEach(p => {
                const diffClass = `difficulty-${p.difficulty}`;
                const diffText = difficultyMap[p.difficulty] || p.difficulty;
                const tagsHtml = p.tags.map(t => `<span>${t}</span>`).join('');

                const div = document.createElement('div'); // æ”¹ä¸º divï¼Œä¸å†åŒ…æ•´ä¸ª a æ ‡ç­¾
                div.className = `problem-card ${diffClass}`;
                
                // å†…éƒ¨ç»“æ„ï¼šæ ‡é¢˜é“¾æ¥ + åˆ é™¤æŒ‰é’®
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <h3 style="margin:0;"><a href="/problem.html?id=${p.id}" style="color:#2c3e50; text-decoration:none;">${p.title}</a></h3>
                        <button onclick="deleteProblem(${p.id}, event)" style="background:none; border:none; color:#aaa; cursor:pointer; font-size:1.2em;">ğŸ—‘ï¸</button>
                    </div>
                    <div class="meta" style="margin-top:10px;">
                        <strong class="${diffClass}">â— ${diffText}</strong>
                    </div>
                    <div class="tags">
                        ${tagsHtml}
                    </div>
                `;
                listDiv.appendChild(div);
            });
            } catch (err) {
                console.error(err);
                loadingDiv.innerText = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
        loadProblems(); 
    </script>
</body>
</html>